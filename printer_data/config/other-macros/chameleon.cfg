

[gcode_macro _CHAMELEON_E_UNLOAD]
description: Unloads the filament from extruder to Y-splitter
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set TOOL = svv.current_tool %}
  {% set YSPLIT_DIST = printer["gcode_macro CHAMELEON_HOME"].ysplit_extruder %}
  {% set SPEED = printer["gcode_macro CHAMELEON_HOME"].chameleon_speed %}
  {% set ACC = printer["gcode_macro CHAMELEON_HOME"].chameleon_acc %}
  
  MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0

  {% if printer["gcode_macro CHAMELEON_HOME"].chameleon_is_homed != 1 or printer.stepper_enable.steppers['manual_stepper selector'] != True %}
    CHAMELEON_HOME
    _TOOL_SELECT TOOL=svv.previous_tool
    {% elif TOOL == 0 or TOOL == 1 %}
      MANUAL_STEPPER STEPPER=chameleon MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
      MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0
    {% else %}
      MANUAL_STEPPER STEPPER=chameleon MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
      MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0
  {% endif %}
  M118 Unload tool {TOOL} from extruder by {YSPLIT_DIST}mm

[gcode_macro _CHAMELEON_E_LOAD]
description: Loads the filament to extruder from Y-splitter
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set TOOL = svv.current_tool %}
  {% set YSPLIT_DIST = printer["gcode_macro CHAMELEON_HOME"].ysplit_extruder %}
  {% set TIP_SHAPING = svv.require_full_tip_shaping %}
  {% set SPEED = printer["gcode_macro CHAMELEON_HOME"].chameleon_speed %}
  {% set ACC = printer["gcode_macro CHAMELEON_HOME"].chameleon_acc %}
  
  MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0

  {% if printer["gcode_macro CHAMELEON_HOME"].chameleon_is_homed != 1 or printer.stepper_enable.steppers['manual_stepper selector'] != True %}
    CHAMELEON_HOME
    _TOOL_SELECT TOOL=svv.previous_tool
  {% elif TIP_SHAPING != "none" %}
    {% if TOOL == 0 or TOOL == 1 %}
      MANUAL_STEPPER STEPPER=chameleon MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
      MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0
    {% else %}
      MANUAL_STEPPER STEPPER=chameleon MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
      MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0
    {% endif %}
  {% else %}  
   {% if TOOL == 0 or TOOL == 1 %}
      MANUAL_STEPPER STEPPER=chameleon MOVE={YSPLIT_DIST + 10} SPEED={SPEED} ACCEL={ACC} STOP_ON_ENDSTOP=1 #to use with solid filaments
      MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0
   {% else %}
      MANUAL_STEPPER STEPPER=chameleon MOVE=-{YSPLIT_DIST + 10} SPEED={SPEED} ACCEL={ACC} STOP_ON_ENDSTOP=1 #to use with solid filaments
      MANUAL_STEPPER STEPPER=chameleon SET_POSITION=0
   {% endif %}
  {% endif %}
  M118 Load tool {TOOL} from Y-splitter to extruder by {YSPLIT_DIST}mm


[gcode_macro EXTRUDER_LOAD]
description: Loads the filament to the extruder after a tool change
gcode:
  {% set EXT_AMNT=printer["gcode_macro CHAMELEON_HOME"].extrude_amount %} 
  {% set SPEED=printer["gcode_macro CHAMELEON_HOME"].chameleon_speed %}
  G92 E0
  G1 E{EXT_AMNT} F{SPEED}
  G92 E0
  
[gcode_macro EXTRUDER_UNLOAD]
description: Unloads the filament from the extruder before a tool change
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set TIP_SHAPING = svv.require_full_tip_shaping %}
  {% if TIP_SHAPING == "none" %}
  {% set moves = params.MOVES | default(5) | int %}
    M83
    {% for _ in range(moves) %}
    G92 E0
    G1 E10 F1500
    G92 E0
    G1 E-15 F1500
    {% endfor %}
    G1 E-45 F2000
    # from gears to SB TOP 45mm, from gears to begining of melting zone on bottom 61mm.
  {% else %}
    {% set temp = params.TEMP | int %}
    {% set stages = params.STAGES | default(4) | int %}
    M106 S255
    {% if stages >= 1 %}
    M104 S180 ; cool down to prevent swelling
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=180
    {% endif %}
    G0 E20 F1500
    G0 E-5 F500
    {% if stages >= 2 %}
    M104 S165
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=165
    {% endif %}
    G0 E5 F1500
    G0 E-1 F500
    {% if stages >= 3 %}
    M104 S155
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=155
    {% endif %}
    G0 E1 F1500
    G0 E-25 F500
    {% if stages >= 4 %}
    M104 S150
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=150
    {% endif %}
    G0 E24 F1500 ; last tip dip with cold tip
    G0 E-24 ; last tip dip with cold tip
    M109 R180 ; ok... go back up in temp so we can move the extruder
    G0 E-80 F500 ; back out of the extruder
    G92 E0
    M107
    M104 S{temp}
  {% endif %}

[gcode_macro T0]
description: Changes the filament to that loaded in tool 0
# variable_tip_shaping:
gcode:
  # fetch current tool
  {% set svv = printer.save_variables.variables %}
  {% set CUR_TOOL = svv.current_tool %}
  {% set PREV_TOOL = svv.previous_tool %}
  # Pause the print
  PAUSE
  {% if CUR_TOOL != 0 or PREV_TOOL != 0 %}
    EXTRUDER_UNLOAD
    _CHAMELEON_E_UNLOAD
  {% endif %}

  # Select the new tool 
  {% set CUR_TOOL=0 %}
  _CHAMELEON_E_LOAD
  EXTRUDER_LOAD
  TOOL_FREE
  # wipe the nozzle a couple of times
  # WIPE
  # continue printing
  RESUME
